<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boarding Management</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, button { padding: 8px; margin: 5px; }
    .top-bar { display: flex; justify-content: flex-end; gap: 10px; }
    .bus-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
    }
    label { display: block; margin-top: 8px; }
  </style>
</head>
<body>

<h2>Bus Boarding Management</h2>

<!-- ðŸ” SEARCH BAR -->
<div class="top-bar">
  <input type="text" id="searchBusNo" placeholder="Bus number">
  <button onclick="searchByBusNo()">Search Bus</button>

  <input type="text" id="searchDriver" placeholder="Driver name">
  <button onclick="searchByDriver()">Search Driver</button>
</div>

<div id="results"></div>

<script>
const token = localStorage.getItem("token");

if (!token) {
  alert("Unauthorized. Please login.");
}

/* ðŸ” SEARCH BY BUS NUMBER */
async function searchByBusNo() {
  const value = document.getElementById("searchBusNo").value;
  fetchBuses(`/api/buses/search/busno?bus_no=${value}`);
}

/* ðŸ” SEARCH BY DRIVER NAME */
async function searchByDriver() {
  const value = document.getElementById("searchDriver").value;
  fetchBuses(`/api/buses/search/driver?name=${value}`);
}

/* ðŸš FETCH + RENDER */
async function fetchBuses(url) {
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  renderBuses(data.allbuses);
}

/* ðŸ–¥ï¸ RENDER BUS */
function renderBuses(buses) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  buses.forEach(bus => {
    const div = document.createElement("div");
    div.className = "bus-card";

    div.innerHTML = `
      <h3>${bus.Busname} (${bus.bus_no})</h3>
      <p><b>Route:</b> ${bus.from} â†’ ${bus.to}</p>
      <p><b>Driver:</b> ${bus.Driver?.name}</p>
      <p><b>Current Boarding:</b> ${bus.Boarding}</p>

      <label>Boarding Status</label>
      <select id="boarding-${bus._id}">
        <option value="true">True</option>
        <option value="false">False</option>
      </select>

      <label>Terminal</label>
      <select id="terminal-${bus._id}">
        <option value="terminal 1">Terminal 1</option>
        <option value="terminal 2">Terminal 2</option>
        <option value="terminal 3">Terminal 3</option>
        <option value="terminal 4">Terminal 4</option>
        <option value="terminal 5">Terminal 5</option>
        <option value="terminal 6">Terminal 6</option>
        <option value="terminal 7">Terminal 7</option>
      </select>

      <label>Section</label>
      <select id="section-${bus._id}">
        <option value="morning">Morning</option>
        <option value="afternoon">Afternoon</option>
        <option value="evening">Evening</option>
        <option value="night">Night</option>
      </select>

      <label>Time Boarding</label>
      <input type="text" id="time-${bus._id}" placeholder="e.g 3:30pm">

      <br><br>
      <button onclick="updateBoarding('${bus._id}')">
        Update Boarding
      </button>
    `;

    container.appendChild(div);
  });
}

/* âœ… UPDATE BOARDING */
async function updateBoarding(busId) {
  const payload = {
    Boarding: document.getElementById(`boarding-${busId}`).value === "true",
    terminal: document.getElementById(`terminal-${busId}`).value,
    section: document.getElementById(`section-${busId}`).value,
    Time_Boarding: document.getElementById(`time-${busId}`).value
  };

  const res = await fetch(`/api/buses/boarding/${busId}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || "Update failed");
    return;
  }

  alert("Boarding updated successfully");
}
</script>

</body>
</html>
